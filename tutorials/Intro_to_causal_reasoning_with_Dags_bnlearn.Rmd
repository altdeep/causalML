---
title: "Introduction to Causal Reasoning on DAGS"
subtitle: "A tutorials using R and the bnlearn package"
author: "Sara Taheri"
date: "5/2/2019"
header-includes:
   - \usepackage{amsmath}
   - \usepackage{soul}
output: 
  html_document:
    self_contained: true
    toc: true
    toc_float: true
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo=TRUE, warning=FALSE, message=FALSE)
library(bnlearn)
library(Rgraphviz)
```

# Overview of a Transportation Survey Data Set

## Survey data
Survey data is a data set that contains information about usage of different transportation systems with a focus on cars and trains for different social groups. It includes these factors:

- **Age (A):** It is recorded as *young* (**young**) for individuals below 30 years, *adult* (**adult**) for individuals between 30 and 60 years old, and *old* (**old**) for people older than 60.

- **Sex (S):** The biological sex of individual, recorded as *male* (**M**) or *female* (**F**).

- **Education (E):** The highest level of education or training completed by the individual, recorded either *high school* (**high**) or *university degree* (**uni**).

- **Occupation (O):** It is recorded as an *employee* (**emp**) or a *self employed* (**self**) worker.

- **Residence (R):** The size of the city the individual lives in, recorded as *small* (**small**) or *big* (**big**).

- **Travel (T):** The means of transport favoured by the individual, recorded as *car* (**car**), *train* (**train**) or *other* (**other**)

Travel is the *target* of the survey, the quantity of interest whose behaviour is under investigation.

```{r, fig.width=3, fig.height=3, fig.align='center'}
# empty graph
dag <- empty.graph(nodes = c("A","S","E","O","R","T"))
arc.set <- matrix(c("A", "E",
                    "S", "E",
                    "E", "O",
                    "E", "R",
                    "O", "T",
                    "R", "T"),
                  byrow = TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
arcs(dag) <- arc.set
nodes(dag)
arcs(dag)
graphviz.plot(dag)
```

# Conditional independence in Bayesian networks

Using a DAG structure we can investigate whether a variable is conditionally independent from another variable given a set of variables from the DAG. If the variables
depend directly on each other, there will be a single arc connecting the nodes
corresponding to those two variables. If the dependence is indirect, there will
be two or more arcs passing through the nodes that mediate the association.

If $\textbf{X}$ and $\textbf{Y}$ are separated by $\textbf{Z}$, we say that $\textbf{X}$ and $\textbf{Y}$ are conditionally independent given $\textbf{Z}$ and denote it with,

$$\textbf{X } { \!\perp\!\!\!\perp}_{G} \textbf{Y } | \textbf{ Z}$$
Conditioning on $\textbf{Z}$ is equivalent to fixing the values of its elements, so that they are known quantities.

$\textbf{Definition (MAPS).}$ Let M be the dependence structure of the probability
distribution P of data $\textbf{D}$, that is, the set of conditional independence relationships linking any triplet $\textbf{X}$, $\textbf{Y}$, $\textbf{Z}$ of subsets of $\textbf{D}$. A graph G is a dependency map
(or **D-map**) of M if there is a one-to-one correspondence between the random
variables in $\textbf{D}$ and the nodes $\textbf{V}$ of G such that for all disjoint subsets $\textbf{X}$, $\textbf{Y}$, $\textbf{Z}$ of $\textbf{D}$ we have

$$\textbf{X } {\!\perp\!\!\!\perp}_{P} \textbf{ Y } | \textbf{ Z} \Longrightarrow  \textbf{X } {\!\perp\!\!\!\perp}_{G} \textbf{ Y } | \textbf{ Z}$$

Similarly, G is an independency map (or **I-map**) of M if

$$\textbf{X } {\!\perp\!\!\!\perp}_{P} \textbf{ Y } | \textbf{ Z} \Longleftarrow  \textbf{X } {\!\perp\!\!\!\perp}_{G} \textbf{ Y } | \textbf{ Z}$$
G is said to be a **perfect map** of M if it is both a D-map and an I-map, that is

$$\textbf{X } {\!\perp\!\!\!\perp}_{P} \textbf{ Y } | \textbf{ Z} \Longleftrightarrow  \textbf{X } {\!\perp\!\!\!\perp}_{G} \textbf{ Y } | \textbf{ Z}$$
and in this case G is said to be **faithful** or **isomorphic** to M.

$\textbf{Definition.}$ A variable V is a **collider** or has a **V structure**, if it has 2 upcoming parents. 

```{r, echo=FALSE, fig.cap="V is a collider", fig.align="center"}
collider_net <- empty.graph(nodes = c("A","B","V"))
arc.set <- matrix(c("A", "V",
                    "B", "V"),
                  byrow = TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
arcs(collider_net) <- arc.set
graphviz.plot(collider_net)
```

You can find all the **V structures** of a DAG:

```{r}
vstructs(dag)
```

Note that conditioning on a collider induces dependence
even though the parents aren't directly connected.

$\textbf{Definition (d-separation)}$ If G is a directed graph in which $\textbf{X}$, $\textbf{Y}$ and $\textbf{Z}$ are disjoint sets of vertices, then $\textbf{X}$ and $\textbf{Y}$ are **d-connected** by $\textbf{Z}$ in G if and only if there exists an undirected path U between some vertex in $\textbf{X}$ and some vertex in $\textbf{Y}$ such that for every collider C on U, either C or a descendent of C is in $\textbf{Z}$, and no non-collider on U is in $\textbf{Z}$. 

$\textbf{X}$ and $\textbf{Y}$ are **d-separated** by $\textbf{Z}$ in G if and only if they are not d-connected by $\textbf{Z}$ in G. 

We assume that graphical separation (${\!\perp\!\!\!\perp}_{G}$) implies probabilistic independence (${\!\perp\!\!\!\perp}_{P}$) in a Bayesian network.

We can investigate whether two nodes in a **bn** object are d-separated using
the **dsep** function. **dsep** takes three arguments, x, y and z, corresponding to
$\textbf{X}$, $\textbf{Y}$ and $\textbf{Z}$; the first two must be the names of two nodes being tested for d-separation, while the latter is an optional d-separating set. So, for example,

```{r}
dsep(dag, x = "S", y = "R")
dsep(dag, x = "O", y = "R")
dsep(dag, x = "S", y = "R", z = "E")
```

## Markov Property, Equivalence classes and CPDAGS

$\textbf{Definition (Local Markov property)}$ Each node $X_i$ is conditionally independent of its non-descendants given its parents.

Compared to the previous decomposition, it highlights the fact that parents
are not completely independent from their children in the BN; a trivial application
of Bayesâ€™ theorem to invert the direction of the conditioning shows
how information on a child can change the distribution of the parent.

Second, assuming the DAG is an I-map also means that serial and divergent
connections result in equivalent factorisations of the variables involved. It is
easy to show that

\begin{align}
Pr(X_i) Pr(X_j | X_i) Pr(X_k | X_j) &= Pr(X_j,X_i) Pr(X_k | X_j)\\
&= Pr(X_i | X_j) Pr(X_j) Pr(X_k | X_j)
\end{align}

Then $X_i \longrightarrow X_j \longrightarrow X_k$ and $X_i \longleftarrow X_j \longrightarrow X_k$ are equivalent. As a result, we
can have BNs with different arc sets that encode the same conditional independence
relationships and represent the same global distribution in different
(but probabilistically equivalent) ways. Such DAGs are said to belong to the
same **equivalence class**.

## Skeleton of a network, CPDAGs and equivalence classes

The skeleton of a network is the network without any direction. Here is the skeleton of the dag for survey dataset.

```{r}
graphviz.plot(skeleton(dag))
```

$\textbf{Theorem. (Equivalence classes)}$ Two DAGs defined over the same set of variables are equivalent and only  they have the same skeleton (i.e., the same underlying undirected graph) and the same v-structures.

```{r}
data(learning.test)
learn.net1 = empty.graph(names(learning.test))
learn.net2 = empty.graph(c("A","B","C","D","E","F"))
modelstring(learn.net1) = "[A][C][F][B|A][D|A:C][E|B:F]"
arc.set2 <- matrix(c("B", "A",
                    "A", "D",
                    "C", "D",
                    "B", "E",
                    "F", "E"),
                  byrow = TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
arcs(learn.net2) <- arc.set2
graphviz.compare(learn.net1,learn.net2)
bnlearn::score(learn.net1, learning.test, type = "loglik")
bnlearn::score(learn.net2, learning.test, type = "loglik")
# type == "loglik" means you get the log likelihood of the data given the dag and the MLE of the parameters
```


In other words, the only arcs whose directions are important are those that
are part of one or more v-structures.

The skeleton of a DAG and it's V structures identify the equivalence class the DAG belongs to, which is represented by the **completed partially directed graph (CPDAG)**. We can obtain it from a DAG with **cpdag** function.

```{r}
X <- paste("[X1][X3][X5][X6|X8][X2|X1][X7|X5][X4|X1:X2]",
           "[X8|X3:X7][X9|X2:X7][X10|X1:X9]", sep = "")
dag2 <- model2network(X)
par(mfrow = c(1,2))
graphviz.plot(dag2)
graphviz.plot(cpdag(dag2))
```

## Moral Graphs

In previous Section  we introduced an alternative graphical representation of the
DAG underlying a BN: the CPDAG of the equivalence class the BN belongs
to. Another graphical representation that can be derived from the DAG is the
**moral graph**.

The moral graph is an undirected graph that is constructed as follows:

1. connecting the non-adjacent nodes in each v-structure with an undirected
arc;

2. ignoring the direction of the other arcs, effectively replacing them
with undirected arcs.

This transformation is called **moralisation** because it "marries" non-adjacent
parents sharing a common child. In the case of our example dag, we can
create the moral graph with the **moral** function as follows:

```{r}
graphviz.plot(moral(dag2))
```

Moralisation has several uses. First, it provides a simple way to transform
a BN into the corresponding Markov network, a graphical model using undirected
graphs instead of DAGs to represent dependencies.

In a Markov network, we say that $\textbf{X} {\!\perp\!\!\!\perp}_{G} \textbf{Y} | \textbf{Z}$ if every path between $\textbf{X}$ and $\textbf{Y}$ contains some node $Z \in \textbf{Z}$.\footnote{https://www.stats.ox.ac.uk/~teh/teaching/probmodels/lecture2graphical.pdf}

## Reference
Bayesian Networks with examples in R" by Scutari and Denis
